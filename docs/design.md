# Text2SQL Agent (Schema-Guided Reasoning)

## Goal
Построить помощника Text2SQL на русском языке, который помогает пользователю составлять корректные SQL-запросы к Trino. Агент ведёт диалог, помогает выбрать таблицы и поля, подсказывает допустимые категориальные значения и может предлагать проверки качества данных через SQL.

## Ключевые требования
- **SGR/Framework**: использовать `sgr-agent-core` и фронтенд `sgr-deep-research-frontend`.
- **SQL-движок**: Trino; агент должен уметь смотреть структуру БД через Trino.
- **Белый список**: параметризированный whitelist схем и таблиц; агент работает только с разрешёнными объектами.
- **LLM**: приватная, совместимая с OpenAPI.
- **Диалоговость**: многошаговое взаимодействие (выбор таблиц/полей, уточнение условий, проверка качества данных).
- **Категориальные значения**: подстановка существующих значений для полей из разрешённых таблиц.
- **Проверка качества данных**: подсказки/шаблоны SQL для типовых проверок (пустые значения, уникальность, диапазоны и т.п.).

## Предлагаемая архитектура
1. **Core (Python, uv)**
   - Внешний слой: адаптер `sgr-agent-core` для orchestration (chain-of-thought/SGR prompts).
   - Поддержка провайдера LLM через OpenAPI-конфиг.
   - Модуль `metadata` для подключения к Trino и загрузки схем с учётом whitelist.
   - Модуль `catalog` для извлечения категориальных значений (distinct/limited) и кэширования.
   - Модуль `prompts` / `reasoning` с SGR-шаблонами для Text2SQL и для "data quality" подсказок.
   - Модуль `dialog` для отслеживания состояния диалога (выбранные таблицы/поля, уточнения, последние SQL).

2. **Frontend**
   - Использовать `sgr-deep-research-frontend` как UI-слой; подключение к backend через API endpoints (FastAPI/Starlette).
   - Поддержка шагов: ввод запроса, выбор таблиц, предпросмотр SQL, запуск на Trino, показ результата/ошибок.

3. **Backend API (через uv)**
   - `POST /api/query` — принимает описание задачи и контекст диалога, возвращает следующий шаг/SQL/уточнения.
   - `POST /api/execute` — выполняет сгенерированный SQL в Trino (только whitelist), возвращает данные/ошибки.
   - `GET /api/schema` — отдаёт разрешённые схемы/таблицы/поля из кеша.
   - `GET /api/categories` — отдаёт категориальные значения для выбранной таблицы/поля (с лимитом).

## Конфигурация
- **Trino**: параметры подключения + конфиг whitelist (список схем/таблиц). Возможен hot-reload через env/файл.
- **LLM**: URL OpenAPI + токен + имя модели; параметры температуры/макс. токенов задаются через конфиг.
- **Квоты и безопасность**: лимитируем выборки (LIMIT) и глубину запросов; запрещаем DDL/DML.

## Следующие шаги
1. Создать каркас uv-проекта (pyproject, src пакет, uv.lock), добавить зависимости `sgr-agent-core`, `trino`, `fastapi`, `pydantic`, `httpx` и т.д.
2. Подготовить базовый backend с заглушками API и интеграцией с `sgr-agent-core` (без реального Trino).
3. Реализовать загрузку схем через Trino + применение whitelist; добавить кеширование на диск/в память.
4. Добавить модуль категориальных значений (distinct/limit) и адаптировать промпты под SGR.
5. Подключить `sgr-deep-research-frontend` (assets/build или отдельный SPA), описать сборку/статические файлы.
6. Настроить E2E поток: диалог → генерация SQL → валидация против схемы → исполнение в Trino → ответ.
7. Подготовить примеры и smoke-тесты (unit + e2e) для генерации и исполнения запросов.
